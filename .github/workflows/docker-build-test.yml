name: Build and Test Container Image

on:
  push:
    branches: [main]
    paths:
      - 'agent-sandbox/**'
      - '.github/workflows/docker-build-test.yml'
  pull_request:
    branches: [main]
    paths:
      - 'agent-sandbox/**'
      - '.github/workflows/docker-build-test.yml'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Podman version
        run: podman --version

      - name: Build container image with Podman
        run: podman build --layers -t agent-sandbox agent-sandbox/

      # -----------------------------------------------------------
      # Image content tests (no persistent volume)
      # -----------------------------------------------------------
      - name: Verify basic system tools
        run: |
          echo "--- Node.js ---"
          podman run --rm agent-sandbox node --version
          echo "--- npm ---"
          podman run --rm agent-sandbox npm --version
          echo "--- Python 3 ---"
          podman run --rm agent-sandbox python3 --version
          echo "--- Git ---"
          podman run --rm agent-sandbox git --version
          echo "--- curl ---"
          podman run --rm agent-sandbox curl --version | head -1
          echo "--- jq ---"
          podman run --rm agent-sandbox jq --version
          echo "--- GitHub CLI ---"
          podman run --rm agent-sandbox gh --version
          echo "--- clang ---"
          podman run --rm agent-sandbox clang --version | head -1
          echo "--- lld ---"
          podman run --rm agent-sandbox ld.lld --version

      - name: Verify coding agents are installed
        run: |
          echo "--- Claude Code ---"
          podman run --rm agent-sandbox claude --version
          echo "--- OpenAI Codex ---"
          podman run --rm agent-sandbox codex --version

      - name: Verify non-root user
        run: |
          WHOAMI=$(podman run --rm agent-sandbox whoami)
          echo "Running as: $WHOAMI"
          if [ "$WHOAMI" != "agent" ]; then
            echo "ERROR: Container should run as 'agent', not '$WHOAMI'"
            exit 1
          fi

      - name: Verify working directory
        run: |
          WORKDIR=$(podman run --rm agent-sandbox pwd)
          echo "Working directory: $WORKDIR"
          if [ "$WORKDIR" != "/workspace" ]; then
            echo "ERROR: Working directory should be /workspace, not '$WORKDIR'"
            exit 1
          fi

      - name: Verify shell environment
        run: |
          SHELL_PATH=$(podman run --rm agent-sandbox sh -c 'echo $SHELL')
          echo "Default shell: $SHELL_PATH"
          if [ "$SHELL_PATH" != "/bin/bash" ]; then
            echo "ERROR: Default shell should be /bin/bash, not '$SHELL_PATH'"
            exit 1
          fi

      - name: Verify cargo/bin is on PATH
        run: |
          # ~/.cargo/bin must be on PATH so that a runtime "rustup" install
          # makes rustc/cargo available immediately without PATH changes.
          PATH_VAL=$(podman run --rm agent-sandbox sh -c 'echo $PATH')
          echo "PATH: $PATH_VAL"
          if ! echo "$PATH_VAL" | grep -q '/home/agent/.cargo/bin'; then
            echo "ERROR: ~/.cargo/bin is not on PATH"
            exit 1
          fi

      - name: Verify home skel template exists
        run: |
          # The entrypoint copies /home/agent.skel into persistent volumes.
          podman run --rm agent-sandbox test -d /home/agent.skel/.npm-global
          echo "/home/agent.skel exists and contains .npm-global"

      - name: Test bind mount capability
        run: |
          mkdir -p /tmp/test-project
          echo "hello from host" > /tmp/test-project/test.txt
          CONTENT=$(podman run --rm -v /tmp/test-project:/workspace agent-sandbox cat /workspace/test.txt)
          echo "Mount test result: $CONTENT"
          if [ "$CONTENT" != "hello from host" ]; then
            echo "ERROR: Bind mount test failed"
            exit 1
          fi

      # -----------------------------------------------------------
      # Persistent home tests (simulates run-agent.sh mount layout)
      #
      # These tests use --userns=keep-id:uid=1000,gid=1000 just like
      # run-agent.sh, so the CI runner's UID maps to the container's
      # "agent" user (UID 1000) and can write to the mounted volume.
      # -----------------------------------------------------------
      - name: Entrypoint populates persistent home on first run
        run: |
          # Mount an empty directory as /home/agent.  The entrypoint should
          # copy /home/agent.skel contents into it and create .home-initialized.
          mkdir -p /tmp/persistent-home
          podman run --rm \
            --userns=keep-id:uid=1000,gid=1000 \
            -v /tmp/persistent-home:/home/agent \
            agent-sandbox test -f /home/agent/.home-initialized
          echo ".home-initialized marker created"

          # Verify key directories were copied from the skel
          for d in .npm-global .claude; do
            if [ ! -d "/tmp/persistent-home/$d" ]; then
              echo "ERROR: $d was not copied into persistent home"
              exit 1
            fi
            echo "  $d: present"
          done
          echo "Persistent home populated correctly"

      - name: Entrypoint skips initialization on subsequent runs
        run: |
          # The persistent home from the previous step already has
          # .home-initialized.  Drop a canary file and verify the
          # entrypoint does NOT overwrite it (i.e. it skips the cp).
          echo "canary" > /tmp/persistent-home/.canary
          podman run --rm \
            --userns=keep-id:uid=1000,gid=1000 \
            -v /tmp/persistent-home:/home/agent \
            agent-sandbox cat /home/agent/.canary | grep -q canary
          echo "Entrypoint correctly skipped re-initialization"

      - name: Agents work with persistent home mount
        run: |
          # run-agent.sh mounts $DATA_HOME/home over /home/agent.
          # Verify agents are reachable after entrypoint initialization.
          podman run --rm \
            --userns=keep-id:uid=1000,gid=1000 \
            -v /tmp/persistent-home:/home/agent \
            -v /tmp/test-project:/workspace \
            agent-sandbox claude --version
          podman run --rm \
            --userns=keep-id:uid=1000,gid=1000 \
            -v /tmp/persistent-home:/home/agent \
            -v /tmp/test-project:/workspace \
            agent-sandbox codex --version
          echo "Agents are reachable with persistent home mount"

      - name: Runtime installs persist across container restarts
        run: |
          # Install a file into the persistent home, then verify it
          # survives in a second container with the same volume.
          podman run --rm \
            --userns=keep-id:uid=1000,gid=1000 \
            -v /tmp/persistent-home:/home/agent \
            agent-sandbox sh -c 'mkdir -p ~/.local/bin && echo "#!/bin/sh" > ~/.local/bin/my-tool && chmod +x ~/.local/bin/my-tool'

          # Second container: verify the file persists
          podman run --rm \
            --userns=keep-id:uid=1000,gid=1000 \
            -v /tmp/persistent-home:/home/agent \
            agent-sandbox test -x /home/agent/.local/bin/my-tool
          echo "Runtime installs persist across container restarts"

      - name: Verify gh and git config overlays on persistent home
        run: |
          # Simulate the mount layout from run-agent.sh:
          #   /home/agent        ← persistent home volume
          #   ~/.config/gh       ← overlaid from host
          #   ~/.gitconfig       ← overlaid from host
          mkdir -p /tmp/gh-config
          echo "github.com:" > /tmp/gh-config/hosts.yml

          HOSTS=$(podman run --rm \
            --userns=keep-id:uid=1000,gid=1000 \
            -v /tmp/persistent-home:/home/agent \
            -v /tmp/gh-config:/home/agent/.config/gh:ro \
            agent-sandbox cat /home/agent/.config/gh/hosts.yml)
          echo "hosts.yml content: $HOSTS"
          if [ "$HOSTS" != "github.com:" ]; then
            echo "ERROR: gh config overlay mount failed"
            exit 1
          fi

          echo -e "[user]\n\tname = Test Agent" > /tmp/test-gitconfig
          GIT_USER=$(podman run --rm \
            --userns=keep-id:uid=1000,gid=1000 \
            -v /tmp/persistent-home:/home/agent \
            -v /tmp/test-gitconfig:/home/agent/.gitconfig:ro \
            agent-sandbox git config user.name)
          echo "git user.name: $GIT_USER"
          if [ "$GIT_USER" != "Test Agent" ]; then
            echo "ERROR: .gitconfig mount failed"
            exit 1
          fi

      - name: Test Python venv creation
        run: |
          podman run --rm agent-sandbox python3 -m venv /tmp/testvenv
          echo "Python venv creation succeeded"
